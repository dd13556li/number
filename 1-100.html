<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1至100數字排序</title>
  <style>
      /* CSS 樣式與 1-10.html 基本相同，此處省略以節省空間 */
      /* --- 請從 1-10.html 複製完整的 <style>...</style> 區塊過來 --- */
      body {
          font-family: 'Arial', sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background-color: #f0f8ff;
          margin: 0;
          padding: 20px;
          box-sizing: border-box;
      }

      h1 {
          color: #2c3e50;
          margin-bottom: 20px;
          text-align: center;
      }

      .container {
          width: 100%;
          max-width: 800px;
          text-align: center;
      }

      /* 開始畫面 */
      #startContainer {
          margin-bottom: 30px;
      }

      button {
          padding: 10px 20px;
          background-color: #2c3e50;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s;
          margin: 5px;
      }

      button:hover {
          background-color: #34495e;
      }

      /* 遊戲區 */
      #gameContainer {
          display: none;
          flex-direction: column;
          align-items: center;
          width: 100%;
      }

      .number-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          margin-bottom: 20px;
          width: 100%;
          background-color: #ecf0f1;
          padding: 15px;
          border-radius: 8px;
      }

      .number-box {
          position: relative;
          width: 60px;
          height: 60px;
          background-color: #3498db;
          color: white;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: bold;
          border-radius: 8px;
          cursor: grab;
          transition: transform 0.2s, background-color 0.3s;
          user-select: none;
          touch-action: none;
      }

      .number-box:active {
          cursor: grabbing;
      }

      .number-box.correct {
          background-color: #2ecc71;
          cursor: default;
      }

      .number-box.incorrect {
          background-color: #e74c3c;
      }

      .check-mark {
          position: absolute;
          top: -20px; /* 調整打勾位置 */
          left: 50%;
          transform: translateX(-50%);
          color: #2ecc71;
          font-size: 20px;
          visibility: hidden;
      }

      .number-box.correct .check-mark {
          visibility: visible;
      }

      .answer-container {
          display: flex;
          flex-wrap: nowrap; /* 強制不換行，以顯示滾動條（如果需要） */
          /* justify-content: center; 改為 flex-start 以便滾動 */
          justify-content: flex-start;
          gap: 10px;
          margin-top: 30px;
          width: 100%;
          min-height: 80px; /* 最小高度 */
          background-color: rgba(255, 255, 255, 0.6);
          border-radius: 8px;
          padding: 15px;
          overflow-x: auto; /* 允許水平滾動 */
          overflow-y: hidden; /* 隱藏垂直滾動條 */
          box-sizing: border-box;
      }

      .slot {
          width: 60px;
          height: 60px;
          min-width: 60px; /* 固定寬度，防止被壓縮 */
          min-height: 60px;
          border: 2px dashed #95a5a6;
          border-radius: 8px;
          display: flex;
          justify-content: center;
          align-items: center;
          margin: 0 5px; /* 調整間距 */
          flex-shrink: 0; /* 防止 flex item 縮小 */
          position: relative;
      }

      .message {
          margin-top: 20px;
          font-size: 20px;
          font-weight: bold;
          color: #2c3e50;
          height: 30px; /* 固定高度防止跳動 */
          line-height: 30px; /* 垂直居中文本 */
      }

      /* 煙火效果 */
      .fireworks-container {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1000;
          display: none;
      }

      .firework {
          position: absolute;
          width: 5px;
          height: 5px;
          border-radius: 50%;
          animation: explode 1s ease-out forwards;
      }

      @keyframes explode {
          0% {
              transform: translate(0, 0);
              opacity: 1;
          }
          100% {
              transform: translate(var(--dx), var(--dy));
              opacity: 0;
          }
      }

      /* 響應式調整 */
      @media (max-width: 800px) {
          .number-container {
              max-width: 100%;
          }
          /* 移除 answer-container 的換行，保持滾動 */
          /* .answer-container {
              padding: 15px 5px;
              flex-wrap: wrap;
              justify-content: center;
          } */
      }

      @media (max-width: 600px) {
          .slot {
              width: 50px;
              height: 50px;
              min-width: 50px;
              min-height: 50px;
              margin: 0 3px;
          }

          .number-box {
              width: 50px;
              height: 50px;
              font-size: 20px;
          }
      }

      @media (max-width: 400px) {
          .slot {
              width: 40px;
              height: 40px;
              min-width: 40px;
              min-height: 40px;
              margin: 0 2px;
          }

          .number-box {
              width: 40px;
              height: 40px;
              font-size: 18px;
          }
      }
  </style>
</head>
<body>
  <div class="container" id="startContainer">
      <h1>1至100數字排序</h1>
      <button id="startGameBtn">開始遊戲</button>
  </div>

  <div class="container" id="gameContainer">
      <h1 id="gameTitle">第 1 關 (1~10)</h1> <div class="number-container" id="numberContainer"></div>
      <div class="answer-container" id="answerContainer"></div>
      <div class="message" id="message"></div>
      </div>

  <div class="fireworks-container" id="fireworksContainer"></div>

  <script>
      // --- 語音功能區 ---
       // 異步加載語音列表
       function loadVoices(callback) {
           let voices = speechSynthesis.getVoices();
           if (voices.length !== 0) {
               callback(voices);
           } else {
               speechSynthesis.onvoiceschanged = () => {
                   voices = speechSynthesis.getVoices();
                   callback(voices);
               };
           }
       }

       // 選擇偏好的語音 (Google zh-TW > 其他 zh-TW > 瀏覽器預設)
       function getPreferredVoice(voices) {
           let voice = voices.find(v => v.lang === 'zh-TW' && v.name.includes('Google'));
           if (!voice) {
               voice = voices.find(v => v.lang === 'zh-TW');
           }
           return voice || null;
       }

       // 播放數字語音（會打斷之前的語音）
       function speakText(text, lang = 'zh-TW') {
           loadVoices((voices) => {
               const preferredVoice = getPreferredVoice(voices);
               const utterance = new SpeechSynthesisUtterance(text);
               if (preferredVoice) {
                   utterance.voice = preferredVoice;
                   utterance.lang = preferredVoice.lang;
               } else {
                   utterance.lang = lang;
               }
               utterance.rate = 1;
               utterance.pitch = 1;

               // *** 核心修改：播放前取消先前的語音 ***
               speechSynthesis.cancel();

               speechSynthesis.speak(utterance);
           });
       }

       // 播放提示語音並等待結束 (不會打斷之前的語音)
       function speakAndWait(text, lang = 'zh-TW') {
           return new Promise((resolve, reject) => {
               loadVoices((voices) => {
                   const preferredVoice = getPreferredVoice(voices);
                   const utterance = new SpeechSynthesisUtterance(text);
                   if (preferredVoice) {
                       utterance.voice = preferredVoice;
                       utterance.lang = preferredVoice.lang;
                   } else {
                      utterance.lang = lang;
                   }
                   utterance.rate = 1;
                   utterance.pitch = 1;
                   utterance.onend = resolve; // 語音結束時 resolve Promise
                   utterance.onerror = reject; // 語音錯誤時 reject Promise

                   // *** 注意：這裡不使用 cancel() ***
                   speechSynthesis.speak(utterance);
               });
           });
       }

      // --- DOM 元素獲取 ---
      const startContainer = document.getElementById('startContainer');
      const startGameBtn = document.getElementById('startGameBtn');
      const gameContainer = document.getElementById('gameContainer');
      const gameTitle = document.getElementById('gameTitle'); // 獲取標題元素
      const numberContainer = document.getElementById('numberContainer');
      const answerContainer = document.getElementById('answerContainer');
      const message = document.getElementById('message');
      const fireworksContainer = document.getElementById('fireworksContainer');

      let correctOrder = [];     // 當前關卡的正確數字順序（字串形式）
      let draggedElement = null; // 拖拉中的元素
      let currentLevel = 1;      // 當前關卡（1~10）
      const totalLevels = 10;    // 總關卡數
      let isChecking = false;    // 標記是否正在檢查答案，防止重複觸發

      // --- 關卡設定 ---
      function setLevel(level) {
          currentLevel = level;
          const start = (level - 1) * 10 + 1;
          const end = level * 10;
          correctOrder = [];
          for (let i = start; i <= end; i++) {
              correctOrder.push(i.toString());
          }
          // 更新標題
          gameTitle.textContent = `第 ${level} 關 (${start}~${end})`;
      }

      // --- 音效播放 --- (同 1-10.html)
      function playSound(soundFile) {
          try {
              const audio = new Audio(soundFile);
              audio.play();
          } catch (e) {
              console.error("無法播放音效:", soundFile, e);
          }
      }
      function playCorrectSound() { playSound("correct.mp3"); }
      function playErrorSound() { playSound("error.mp3"); }
      function playSuccessSound() { playSound("success.mp3"); }

      // --- 煙火效果 --- (同 1-10.html)
      function createFireworks() {
          fireworksContainer.style.display = 'block';
          fireworksContainer.innerHTML = '';
          playSuccessSound();
          for (let i = 0; i < 5; i++) {
              setTimeout(() => {
                  const x = Math.random() * window.innerWidth;
                  const y = Math.random() * window.innerHeight * 0.5;
                  createFirework(x, y);
              }, i * 300);
          }
          // 動畫結束後隱藏
           setTimeout(() => {
               fireworksContainer.style.display = 'none';
               // 成功訊息的顯示和語音由 checkCompletion 控制
           }, 2500);
      }

      function createFirework(x, y) {
          const colors = ['#ff0000', '#ffff00', '#00ff00', '#00ffff', '#0000ff', '#ff00ff'];
          const particleCount = 30;
          for (let i = 0; i < particleCount; i++) {
              const particle = document.createElement('div');
              particle.className = 'firework';
              particle.style.left = `${x}px`;
              particle.style.top = `${y}px`;
              particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
              const angle = Math.random() * Math.PI * 2;
              const distance = 50 + Math.random() * 100;
              const dx = Math.cos(angle) * distance;
              const dy = Math.sin(angle) * distance;
              particle.style.setProperty('--dx', `${dx}px`);
              particle.style.setProperty('--dy', `${dy}px`);
              fireworksContainer.appendChild(particle);
              particle.addEventListener('animationend', () => {
                  particle.remove();
              });
          }
      }

      // --- 遊戲邏輯 ---
      // Fisher-Yates 洗牌
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      }

      // 初始化遊戲關卡
      function initLevel() {
          isChecking = false; // 重置檢查狀態
          numberContainer.innerHTML = '';
          answerContainer.innerHTML = '';
          message.textContent = '';
          message.style.color = '#2c3e50';

          // 獲取當前關卡數字並洗牌
          const numbersToShuffle = correctOrder.slice();
          shuffleArray(numbersToShuffle);

          // 建立數字方塊
          numbersToShuffle.forEach(num => {
              const numberBox = document.createElement('div');
              numberBox.className = 'number-box';
              numberBox.textContent = num;
              numberBox.dataset.value = num;
              numberBox.draggable = true;

              const checkMark = document.createElement('div');
              checkMark.className = 'check-mark';
              checkMark.innerHTML = '✓';
              numberBox.appendChild(checkMark);

              // --- 事件監聽 (與 1-10.html 相同) ---
               // 桌面拖曳開始
              numberBox.addEventListener('dragstart', (e) => {
                  if (numberBox.classList.contains('correct')) {
                      e.preventDefault(); return;
                  }
                  draggedElement = numberBox;
                  e.dataTransfer.setData('text/plain', num);
                  setTimeout(() => { numberBox.style.opacity = '0.5'; }, 0);
                  speakText(num.toString()); // 播放數字語音
              });

              // 桌面拖曳結束
              numberBox.addEventListener('dragend', () => {
                  if (draggedElement === numberBox) {
                    numberBox.style.opacity = '1';
                    draggedElement = null;
                  }
              });

              // 觸控開始
              numberBox.addEventListener('touchstart', (e) => {
                 if (numberBox.classList.contains('correct')) return;
                  // passive: false in setupTouchDragSupport allows preventDefault if needed
                  draggedElement = numberBox;
                  speakText(num.toString()); // 播放數字語音
                  numberBox.style.opacity = '0.7';
              }, { passive: true }); // Start can be passive

              // 點擊事件
              numberBox.addEventListener('click', () => {
                  if (!numberBox.classList.contains('correct')) {
                      speakText(num.toString()); // 播放數字語音
                  }
              });

              numberContainer.appendChild(numberBox);
          });

          // 建立答案插槽
          for (let i = 0; i < correctOrder.length; i++) {
              const slot = document.createElement('div');
              slot.className = 'slot';
              slot.dataset.position = i;

              // --- 放置區事件監聽 ---
              slot.addEventListener('dragover', (e) => { e.preventDefault(); });
              slot.addEventListener('dragenter', (e) => {
                 e.preventDefault();
                 const existingBox = slot.querySelector('.number-box');
                  if (!existingBox || !existingBox.classList.contains('correct')) {
                     slot.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
                  }
              });
              slot.addEventListener('dragleave', () => { slot.style.backgroundColor = ''; });
              slot.addEventListener('drop', (e) => {
                  e.preventDefault();
                  slot.style.backgroundColor = '';
                  if (!draggedElement) return;

                  const existingBox = slot.querySelector('.number-box');
                  if (existingBox && existingBox.classList.contains('correct')) {
                      return; // 不替換正確的
                  }
                  if (existingBox && existingBox !== draggedElement) {
                      existingBox.classList.remove('incorrect', 'correct');
                      numberContainer.appendChild(existingBox);
                  }
                  if (draggedElement.parentNode !== slot) {
                      slot.appendChild(draggedElement);
                  }
                  draggedElement.style.opacity = '1';

                  const num = draggedElement.dataset.value;
                  const correctNum = correctOrder[i];

                  if (num === correctNum) {
                      draggedElement.classList.remove('incorrect');
                      draggedElement.classList.add('correct');
                      playCorrectSound();
                  } else {
                      draggedElement.classList.remove('correct');
                      draggedElement.classList.add('incorrect');
                      playErrorSound();
                  }
                  draggedElement = null;
                  // 放置後檢查是否完成
                  checkCompletion();
              });
              answerContainer.appendChild(slot);
          }

          // 允許拖回上方
          numberContainer.addEventListener('dragover', (e) => { e.preventDefault(); });
          numberContainer.addEventListener('drop', (e) => {
              e.preventDefault();
              if (draggedElement && draggedElement.parentNode.classList.contains('slot')) {
                  draggedElement.classList.remove('incorrect', 'correct');
                  numberContainer.appendChild(draggedElement);
                  draggedElement.style.opacity = '1';
                  draggedElement = null;
              }
          });

          // 觸控支援
          setupTouchDragSupport();
          // 調整容器
          adjustContainers();
      }

       // 觸控拖拉支援 (與 1-10.html 相同，需處理放置後 checkCompletion)
      function setupTouchDragSupport() {
          let touchStartX, touchStartY, elementStartX, elementStartY;

          document.addEventListener('touchmove', (e) => {
              if (!draggedElement) return;
              e.preventDefault(); // Prevent scrolling while dragging
              const touch = e.touches[0];
              const currentX = touch.clientX;
              const currentY = touch.clientY;
              const dx = currentX - touchStartX;
              const dy = currentY - touchStartY;
              draggedElement.style.position = 'fixed';
              draggedElement.style.zIndex = 1000;
              draggedElement.style.left = `${elementStartX + dx}px`;
              draggedElement.style.top = `${elementStartY + dy}px`;
          }, { passive: false });

          document.addEventListener('touchend', (e) => {
              if (!draggedElement) return;
              draggedElement.style.opacity = '1';
              const touch = e.changedTouches[0];
              const endX = touch.clientX;
              const endY = touch.clientY;
              let droppedInSlot = false;
              const slots = answerContainer.querySelectorAll('.slot');

              slots.forEach((slot) => {
                  const rect = slot.getBoundingClientRect();
                  if (endX >= rect.left && endX <= rect.right &&
                      endY >= rect.top && endY <= rect.bottom) {

                      const existingBox = slot.querySelector('.number-box');
                      if (existingBox && existingBox.classList.contains('correct')) {
                         resetDraggedElementPosition(); // Cannot replace correct one
                         return;
                      }
                      if (existingBox && existingBox !== draggedElement) {
                          existingBox.classList.remove('incorrect', 'correct');
                          numberContainer.appendChild(existingBox);
                          resetElementStyle(existingBox);
                      }
                      slot.appendChild(draggedElement);
                      resetElementStyle(draggedElement);

                      const num = draggedElement.dataset.value;
                      const position = parseInt(slot.dataset.position);
                      const correctNum = correctOrder[position];

                      if (num === correctNum) {
                          draggedElement.classList.remove('incorrect');
                          draggedElement.classList.add('correct');
                          playCorrectSound();
                      } else {
                          draggedElement.classList.remove('correct');
                          draggedElement.classList.add('incorrect');
                          playErrorSound();
                      }
                      droppedInSlot = true;
                      // *** 觸控放置後檢查完成狀態 ***
                      checkCompletion();
                  }
              });

              if (!droppedInSlot) {
                  resetDraggedElementPosition();
              }
              draggedElement = null;
          });

          // Add touchstart listener here as well to initialize drag
           document.addEventListener('touchstart', (e) => {
               if (e.target.classList.contains('number-box') && !e.target.classList.contains('correct')) {
                   draggedElement = e.target;
                   const touch = e.touches[0];
                   touchStartX = touch.clientX;
                   touchStartY = touch.clientY;
                   const rect = draggedElement.getBoundingClientRect();
                   elementStartX = rect.left;
                   elementStartY = rect.top;
                   // Opacity and speakText are handled in the main touchstart listener for the box
               }
           }, { passive: true });


            function resetDraggedElementPosition() {
                if (!draggedElement) return;
                const originalParent = numberContainer;
                originalParent.appendChild(draggedElement);
                resetElementStyle(draggedElement);
                draggedElement.classList.remove('incorrect', 'correct');
            }

            function resetElementStyle(element) {
                element.style.position = '';
                element.style.zIndex = '';
                element.style.left = '';
                element.style.top = '';
                element.style.opacity = '1';
            }
      }


      // 檢查是否所有數字都已正確放置 (自動觸發)
      async function checkCompletion() {
          // 防止在處理上一次檢查時重複觸發
          if (isChecking) return;

          const slots = answerContainer.querySelectorAll('.slot');
          let allFilled = true;
          let allCorrect = true;

          if (slots.length !== correctOrder.length) return; // 數量不對，可能還在初始化

          slots.forEach((slot, index) => {
              const box = slot.querySelector('.number-box');
              if (!box) {
                  allFilled = false; // 有空格
              } else if (!box.classList.contains('correct')) {
                  // 即使填滿了，只要有一個不是 correct 狀態就算未完成或錯誤
                  allCorrect = false;
                  // 可以在這裡再次驗證，確保 classList 正確
                  if (box.dataset.value !== correctOrder[index]) {
                      box.classList.add('incorrect');
                  }
              }
          });

          // 只有當所有格子都填滿時才進行最終判斷
          if (!allFilled) {
              return; // 還沒填完，不做任何事
          }

          isChecking = true; // 開始檢查，設置標記

          if (allCorrect) {
              // --- 全部正確 ---
              message.textContent = "太棒了，你答對了！";
              message.style.color = '#2ecc71';
              createFireworks(); // 顯示煙火

              try {
                  // 等待成功語音播放完畢
                  await speakAndWait("太棒了，你答對了");

                  // 延遲一小段時間讓使用者看到結果
                  await new Promise(resolve => setTimeout(resolve, 1500)); // 等待 1.5 秒

                  // 檢查是否還有下一關
                  if (currentLevel < totalLevels) {
                      currentLevel++;
                      setLevel(currentLevel); // 設定下一關數據
                      initLevel(); // 初始化下一關界面
                      requestAnimationFrame(adjustContainers); // 調整佈局
                  } else {
                      // --- 完成所有關卡 ---
                      message.textContent = "恭喜你完成所有關卡！";
                      message.style.color = '#2ecc71';
                      await speakAndWait("恭喜你完成所有關卡！");
                      // 可以選擇顯示一個結束畫面或按鈕
                      // 例如：顯示開始按鈕，隱藏遊戲區
                       startContainer.style.display = 'block';
                       gameContainer.style.display = 'none';
                  }
              } catch (error) {
                  console.error("語音播放失敗:", error);
                  // 即使語音失敗，也嘗試繼續流程
                  if (currentLevel < totalLevels) {
                     currentLevel++; setLevel(currentLevel); initLevel(); requestAnimationFrame(adjustContainers);
                  } else {
                     message.textContent = "恭喜你完成所有關卡！"; message.style.color = '#2ecc71';
                     startContainer.style.display = 'block'; gameContainer.style.display = 'none';
                  }
              } finally {
                 // isChecking = false; // 在下一關初始化時重置
              }

          } else {
              // --- 有錯誤 ---
              message.textContent = "對不起，有錯誤喔，請再試一次。";
              message.style.color = '#e74c3c';
              playErrorSound(); // 播放錯誤音效

              try {
                  // 等待錯誤提示語音播放完畢
                  await speakAndWait("對不起，有錯誤喔，請再試一次。");

                  // 將錯誤的數字移回上方
                  slots.forEach((slot) => {
                      const box = slot.querySelector('.number-box');
                      // 僅移除非 correct 狀態的方塊
                      if (box && !box.classList.contains('correct')) {
                          slot.removeChild(box);
                          box.classList.remove('incorrect'); // 清除錯誤標記
                          numberContainer.appendChild(box); // 移回上方
                      }
                  });
              } catch (error) {
                   console.error("語音播放失敗:", error);
                   // 語音失敗，仍執行移除錯誤方塊的邏輯
                   slots.forEach((slot) => {
                      const box = slot.querySelector('.number-box');
                      if (box && !box.classList.contains('correct')) {
                          slot.removeChild(box); box.classList.remove('incorrect'); numberContainer.appendChild(box);
                      }
                  });
              } finally {
                  isChecking = false; // 檢查結束，解除標記
              }
          }
      }


      // 調整答案插槽尺寸 (同 1-10.html)
       function adjustContainers() {
           if (!answerContainer || answerContainer.offsetWidth === 0) {
              requestAnimationFrame(adjustContainers);
              return;
           }
           const containerWidth = answerContainer.offsetWidth;
           const slotCount = correctOrder.length;
           if (slotCount === 0) return;

           const gap = 10;
           const padding = 30; // 假設左右各有 15px padding
           // 考慮到 overflow-x: auto，這裡的寬度計算可能需要調整
           // 保持固定大小或基於視口寬度可能更簡單
           let slotSize = 60; // 預設大小
           if (window.innerWidth < 600) slotSize = 50;
           if (window.innerWidth < 400) slotSize = 40;

           document.querySelectorAll('.slot').forEach(slot => {
               slot.style.width = `${slotSize}px`;
               slot.style.height = `${slotSize}px`;
               slot.style.minWidth = `${slotSize}px`;
               slot.style.minHeight = `${slotSize}px`;
           });
            // 確保容器高度足夠
           answerContainer.style.minHeight = `${slotSize + 30}px`; // 加上 padding
       }

      window.addEventListener('resize', adjustContainers);

      // --- 事件綁定 ---
      startGameBtn.addEventListener('click', () => {
          setLevel(1); // 從第一關開始
          startContainer.style.display = 'none';
          gameContainer.style.display = 'flex';
          initLevel(); // 初始化第一關
          requestAnimationFrame(adjustContainers);
      });

  </script>
</body>
</html>
